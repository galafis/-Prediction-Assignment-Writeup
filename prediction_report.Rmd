---
title: "Predicting Exercise Quality with Machine Learning"
author: "Gabriel Demetrios Lafis"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    theme: united
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 8, fig.height = 5, fig.align = 'center')
```

# Introduction

This project classifies weightlifting exercise quality using accelerometer data from belt, forearm, arm, and dumbbell sensors.

# Data Preparation

First, we load the necessary libraries and the dataset:

```{r}
library(caret)
library(randomForest)
library(ggplot2)
library(dplyr)
```

```{r}
# Download data if not already present
if (!file.exists("pml-training.csv")) {
  download.file("https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv", 
                "pml-training.csv")
}
if (!file.exists("pml-testing.csv")) {
  download.file("https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv", 
                "pml-testing.csv")
}

# Load the data
training <- read.csv("pml-training.csv")
testing <- read.csv("pml-testing.csv")
```

# Data Cleaning

```{r}
# Remove columns with >95% NAs
training <- training[, colMeans(is.na(training)) < 0.95]
testing <- testing[, colMeans(is.na(testing)) < 0.95]

# Remove metadata columns
cols_to_remove <- c("X", "user_name", "raw_timestamp_part_1", 
                   "raw_timestamp_part_2", "cvtd_timestamp",
                   "new_window", "num_window")
training <- training[, !names(training) %in% cols_to_remove]
testing <- testing[, !names(testing) %in% cols_to_remove]

# Convert classe to factor
training$classe <- as.factor(training$classe)
```

# Model Building

```{r}
set.seed(123)
train_idx <- createDataPartition(training$classe, p = 0.7, list = FALSE)
train_data <- training[train_idx, ]
valid_data <- training[-train_idx, ]
```

```{r}
set.seed(123)
rf_model <- randomForest(classe ~ ., data = train_data, ntree = 100)
```

## Model Evaluation

```{r}
pred_valid <- predict(rf_model, valid_data)
confusionMatrix(pred_valid, valid_data$classe)
```

# Final Predictions

```{r}
# Step 1: Get predictor columns from train_data
predictor_cols <- names(train_data)[names(train_data) != "classe"]

# Step 2: Ensure test_data has all required predictor columns
existing_cols <- intersect(predictor_cols, names(testing))
test_data <- testing[, existing_cols, drop = FALSE]

# Step 3: Add missing columns as NA_real_
missing_cols <- setdiff(predictor_cols, names(test_data))
test_data[missing_cols] <- NA_real_

# Step 4: Reorder test_data to match predictor_cols
test_data <- test_data[, predictor_cols]

# Step 5: Convert everything to numeric (handles factor-to-numeric safely)
test_data <- as.data.frame(lapply(test_data, as.numeric))

all_na_cols <- colnames(test_data)[colSums(is.na(test_data)) == nrow(test_data)]
for (col in all_na_cols) {
  test_data[[col]] <- 0  # or mean from training, or median, etc.
}
# Step 6: Use randomForest's roughfix to impute missing values
test_data <- na.roughfix(test_data)

# Step 7: Double-check no NAs
stopifnot(sum(is.na(test_data)) == 0)

# Step 8: Make predictions
test_pred <- predict(rf_model, test_data)

# Step 9: Output predictions 1 to 20
test_pred[1:20]
```

# Conclusion

The model achieved excellent accuracy. Key predictors were movement patterns from belt and forearm sensors.

```{r}
sessionInfo()
```
